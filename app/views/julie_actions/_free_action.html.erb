<%= javascript_include_tag 'automatic_templates_manager' %>
<script>
    window.drawCalendarCallback = function(){
        if(window.threadAccount) {
            window.activateCalendarWithParams({
                mode: "free_calendar",
                date_times: [],
                email: "<%= @message.messages_thread.account_email %>",
                duration: <%= @message.messages_thread.computed_data[:duration] || 60 %>
            });
        }
        else {
            $("#show-calendar-button").hide();
        }

        $(".calendar-container").addClass("minimized");
    };

    window.afterReplyBoxInitCallback = function(){
        window.setReplyMessage("", "only_client");
    };

    $(function() {

        window.templateManager = new TemplateManager({
            categories: ['free_reply'],
            skipDefaultItem: true,
            onItemSelected: function(clickedNode, template) {
                window.setReplyMessage(template, "only_client");
            }
        });

        initializeEmailLanguageSelector();
    });

    function initializeEmailLanguageSelector(){

        var $languageSelector = $("<div>").addClass("language-selector-container");
        $languageSelector.append($("<div>").addClass("selector").data("value", "en").html("EN"));
        $languageSelector.append($("<div>").addClass("selector").data("value", "fr").html("FR"));

        $(".reply-box").append($languageSelector);

        $(".language-selector-container .selector").click(function() {
            window.threadComputedData.locale = $(this).data("value");

            window.templateManager.refreshCurrentSelectedTemplate();
        });

        $('.email.extended').removeClass('extended');
    };

    window.afterReplyBoxInitCallback = function(){
        window.setReplyMessage("", "only_client");

        window.templateManager.fetchTemplates();
    };
</script>