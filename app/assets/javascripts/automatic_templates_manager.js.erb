var TemplateManager = function(params){
    this.categories = params.categories;

    this.menuButtonNode = params.menuButtonNode || $(".template-manager-menu-button");
    this.menuPanelWrapperNode = params.menuPanelWrapperNode || $(".template-manager-menu-wrapper");
    this.filterQueryInputNode = params.filterQueryInputNode || $("#template_manager_query_input");
    this.menuPanelNode = params.menuPanelNode || $(".template-manager-menu");
    this.menuPanelItemClass = params.menuPanelItemClass || "template-manager-menu-item";

    this.templates = [];
    this.currentSelectedTemplate = null;

    this.skipDefaultItem = params.skipDefaultItem || false;

    this.onItemSelected = params.onItemSelected;

    this.templatesVariablesRegexps = [
      new RegExp('%{event_type}', 'g')
    ];

    this.templatesVariablesValues = [
        {value: window.getCurrentAppointment && window.getCurrentAppointment() && window.getCurrentAppointment().title_in_calendar, localized: true}
    ];

    this.menuPanelWrapperNode.hide();

    this.currentQuery = '';

    var host = "<%= ENV['JULIEDESK_APP_BASE_PATH'] %>";
    var accessKey = "<%= ENV['JULIEDESK_APP_API_KEY'] %>";

    var that = this;

    this.fetchTemplates = function() {
        $.ajax({
            url: host + "/api/v1/julie_templates",
            data: {categories: that.categories},
            type: "GET",
            contentType: "application/json",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", accessKey);
            },
            success: function (response) {
                var data = response.data;
                that.menuPanelNode.html("");
                that.menuPanelWrapperNode.hide();
                _(data).each(function (item) {
                    var $menuItem = $("<div>").addClass(that.menuPanelItemClass).html(item.title).data("template-en", item.template_en).data("template-fr", item.template_fr);
                    that.templates.push($menuItem);
                    that.menuPanelNode.append($menuItem);
                });

                setTimeout(function() {
                    if(!that.skipDefaultItem) {
                        that.clickOnTemplateItem(that.templates[0]);
                    }
                }, 500);
            }
        });
    };

    this.onQueryInputKeyup = function() {
      that.updateFilterQuery();
      that.filterTemplates();
    };

    this.updateFilterQuery = function() {
      that.currentQuery = that.filterQueryInputNode.val();
    };

    this.filterTemplates = function() {
      _.each(that.templates, function(template) {
        var filtered = true;

        if(that.currentQuery && that.currentQuery != '') {
          filtered = template.text().toLowerCase().indexOf(that.currentQuery.toLowerCase()) > -1;
        }

        if(filtered) {
          template.show();
        } else {
          template.hide();
        }

      });
    };

    this.refreshCurrentSelectedTemplate = function(noTemplateSelectedCallback) {
        if(that.currentSelectedTemplate) {
            that.clickOnTemplateItem(that.currentSelectedTemplate);
        }else {
            noTemplateSelectedCallback();
        }
    };

    this.filterQueryInputNode.on('keyup', function() {
      that.onQueryInputKeyup();
    });

    this.menuPanelNode.on("click", "." + that.menuPanelItemClass, function() {
        var currentItem = $(this);

        trackActionV2('Click_on_template', {ux_element: 'backoffice', template_title: currentItem.text()});
        that.clickOnTemplateItem(currentItem);
    });

    this.clickOnTemplateItem = function($item) {
        var template = '';

        if(window.threadComputedData.locale == 'fr') {
            template = $item.data("template-fr");
        }else {
            template = $item.data("template-en");
        }

        template = that.replaceVariables(template);
        that.currentSelectedTemplate = $item;

        if(that.onItemSelected)
            that.onItemSelected($item, template);

        that.menuPanelWrapperNode.hide();
    };

    this.menuButtonNode.click(function() {
        that.menuPanelWrapperNode.toggle();
    });

    this.replaceVariables = function(template) {
        var currentValue;

        for(var i =0; i< that.templatesVariablesRegexps.length; i++) {
            currentValue = that.templatesVariablesValues[i];
            if(currentValue.value) {
                if(currentValue.localized) {
                    currentValue = currentValue.value[window.threadComputedData.locale]
                } else {
                    currentValue = currentValue.value;
                }

                template = template.replace(that.templatesVariablesRegexps[i], currentValue.toLowerCase());
            }

        }

        return template;
    };
};