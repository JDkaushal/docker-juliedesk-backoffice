<%=render 'invitation_already_sent_base_functions'%>

<script>
    var isPostpone = <%= (messages_thread.event_data[:event_id].present?)?"true":"false" %>;
    window.leftColumnMessage = "Create event";
    window.suggestedDates = <%== @messages_thread.suggested_date_times.map{|d| d['date']}.to_json %>;

    var noDateFitsType = "<%=
        date_times_to_check = JSON.parse(@julie_action.message_classification.date_times)
        suggested_date_times = @messages_thread.suggested_date_times
        if date_times_to_check.length > 1
            if (date_times_to_check & suggested_date_times).empty?
                "not_suggested_multiple"
            else
                "suggested_multiple"
            end
        else
            if (date_times_to_check & suggested_date_times).empty?
                "not_suggested_single"
            else
                "suggested_single"
            end
        end
        %>";

    window.drawCalendarCallback = function(){
        window.activateCalendarWithParams({
            mode: "create_event",
            // We do .uniq{|date_object| date_object['date']} so we will keep only the first occurrence of a date, aka the "to_check" version if there are several
            date_times: <%== (JSON.parse(
            @julie_action.message_classification.date_times || "[]").select{|dt|dt['date']}.map{|dt| dt['date']}.map{|date|
              {
                      mode: "to_check",
                      date: date
              }
            } + @messages_thread.suggested_date_times.select{|dt| dt['date']}.map{|dt| dt['date']}.map{|date|
              {
                      mode: "already_suggested",
                      date: date
              }
            }).uniq{|date_object| date_object[:date]}.to_json %>,
            email: window.threadAccount.email,
            duration: window.threadComputedData.duration,
            calendarandEventsLoadedFirstTimeCallback: function() {
                if($(".suggested-date-time").length > 0) {
                    var dateTime = $(".suggested-date-time:eq(0)").data("date");
                    if (dateTime) {
                        setTimeout(function() {
                            window.currentCalendar.selectSuggestedEvent(dateTime);
                        }, 100);
                    }
                }
            }
        });
    };

    window.afterReplyBoxInitCallback = function() {
        window.setReplyMessage("");
    };

    $(function () {
        $(".messages-thread-info-panel .create-event-panel").show();
        if(window.threadComputedData.client_agreement) {
            $(".messages-thread-info-panel .create-event-panel #create-event-button").html("Create event");
            if(isPostpone) {
                $(".messages-thread-info-panel .create-event-panel #create-event-button").html("Update event");
                window.afterEventFetched = function() {
//                    window.otherEmails = _.map(window.currentEventTile.event.attendees, function (attendee) {
//                        return attendee.email;
//                    });
                    window.otherEmails = [];
                }
            }
            $(".messages-thread-info-panel .create-event-panel .suggested-date-time-container input[type='checkbox']").hide();
        }
        else {
            $(".messages-thread-info-panel .create-event-panel #create-event-button").html("Select");
        }

        var currentAppointment = window.getCurrentAppointment();
        if(currentAppointment && currentAppointment.include_email_in_notes) {
            $("input[type=checkbox]#include-email-in-notes").attr("checked", true);
        }

        $(".messages-thread-info-panel .create-event-panel .suggested-date-time-container input[type='checkbox']").change(function() {
            if($(".messages-thread-info-panel .create-event-panel .suggested-date-time-container input[type='checkbox']:checked").length > 0) {
                $("#create-event-button").removeAttr('disabled');
            }
            else {
                $("#create-event-button").attr('disabled', true);
            }
        });

        $("#no-date-fits").click(function () {      
            window.timeSlotToCreate = null;
            var aiDatesSuggestionsManager = $('#dates-suggestion-manager').scope();

            if(aiDatesSuggestionsManager && window.threadComputedData.client_agreement) {
              new Feature('ai_dates_suggestions', aiDatesSuggestionsManager).fetchAiDatesSuggestions(true);
            }
            $(".messages-thread-info-panel .create-event-panel").hide();
            clearDatesToCheck();

            if(window.threadComputedData.client_agreement) {
                window.currentCalendar.initialData.mode = "suggest_dates";
                $(".messages-thread-info-panel .message-container").html("Pick new availabilities");
            }
            else {
                var timeSlotsToCheck = $(".messages-thread-info-panel .create-event-panel .suggested-date-time").map(function() {
                    var $suggestedDateTime = $(this);
                    return moment.tz($suggestedDateTime.data("date"), $suggestedDateTime.data("timezone")).format();
                }).get();
                var messageBuilder = $('#reply-area').scope();

                $(".calendar-container").addClass("minimized");
                window.setReplyMessage(messageBuilder.generateReply({
                    action: "client_agreement",
                    isPostpone: isPostpone,
                    dateTimesToCheck: timeSlotsToCheck,
                    isAvailable: false,
                    appointment: window.getCurrentAppointment(),
                    timezoneId: window.threadComputedData.timezone,
                    defaultTimezoneId: window.threadAccount.default_timezone_id,
                    locale: window.threadComputedData.locale
                }), "only_client");
            }

        });

        $("#invitation-already-sent-button").click(function () {
            window.invitationAlreadySent = true;
            window.currentCalendar.initialData.mode = "select_events";
            $(".messages-thread-info-panel .message-container").html("Invitation already sent");
            $('.create-event-panel').hide();
            enableInvitationAlreadySentFlow();
        });

        function clearDatesToCheck() {
            _.each(window.currentCalendar.$selector.find("#calendar").fullCalendar("clientEvents", function (ev) {
                return ev.beingAdded;
            }), function(e) {
                e.color = "#ccc";
            });

            window.currentCalendar.$selector.find('#calendar').fullCalendar('rerenderEvents');
        };

        function enableInvitationAlreadySentFlow() {

            $("#thread-header-other-entries-container").on('click', '#confirm_invitation_noted', function(e) {
                $(".calendar-container").addClass("minimized");
                $(".left-column").animate({scrollTop: $(".reply-box").position().top + 30}, 300);
            });

            $("#thread-header-other-entries-container").on('click', '#invitation-sent-no-date-fits', function(e) {
                window.timeSlotsToSuggest = null;
                window.pickingNewAvailabilities = true;
                $(".messages-thread-info-panel .selected-events-list-container").hide();
                window.currentCalendar.initialData.mode = "suggest_dates";
                $(".messages-thread-info-panel .message-container").html("Pick new availabilities");
            });

            window.clickReplyButton = function() {
                var invitationAlreadyPresent = <%= (messages_thread.event_data[:event_id].present? && messages_thread.event_data[:event_from_invitation]) ? "true":"false" %>;

                if(window.pickingNewAvailabilities) {
                    invitationAlreadySentDeleteEvent({
                        eventId: window.selectedEvents[0].id,
                        calendarLoginUsername: window.selectedEvents[0].calendar_login_username,
                        eventUrl: window.selectedEvents[0].url,
                        calendarId: window.selectedEvents[0].calId
                    }, function() {
                        associateInvitationToThread(true);
                    });
                    // When another invitation has been received we want to discard the current and link the new with the current thread
                }else if(invitationAlreadyPresent) {
                    var currentEventId = window.currentEventTile.eventId;
                    // Don't
                    if(currentEventId == window.selectedEvents[0].id) {
                        var data = {
                            text: $("textarea#reply-text").val(),
                            generated_text: window.currentFullMessageWithFooter,
                            to: window.currentRecipients().to,
                            cc: window.currentRecipients().cc,
                            done: true,
                            processed_in: Date.now() - window.startedAt,
                            messages_thread_id: "<%= @messages_thread.id %>",
                            client_settings: window.getClientSettings()
                        };

                        $.ajax({
                            url: "/julie_actions/<%= @julie_action.id %>/update",
                            method: "post",
                            data: data
                        });
                        window.sendReply();
                    }else {
                        invitationAlreadySentDeleteEvent({
                            eventId: currentEventId,
                            calendarLoginUsername: window.currentEventTile.calendarLoginUsername,
                            eventUrl: window.currentEventTile.eventUrl,
                            calendarId: window.currentEventTile.calendarId
                        }, function() {
                            associateInvitationToThread(false);
                        });
                    }
                }else{
                    associateInvitationToThread(false);
                }
            };
        };

        $("#create-event-button").click(function () {
            var eventCreatorManager = $('#datesVerificationsManager').scope();

            if(window.threadComputedData.client_agreement) {
                var currentTimezone = window.currentCalendar.getCalendarTimezone();
                var meetingRoomManager = $('#meeting-rooms-manager').scope();
                var vmHelper = angular.element($('#virtual-meetings-helper')).scope();

                trackActionV2('Click_on_create_event', {ux_element: 'standCE', meeting_room: meetingRoomManager.usingMeetingRoom});

                window.currentEventFromInvitation = "<%= @messages_thread.event_data[:event_from_invitation] %>" == "true";

                $("#create-event-button").attr('disabled', true);
                $(".creating-event-message").html("Creating...");
                var start = moment(eventCreatorManager.selectedDateRaw).tz(currentTimezone);
                var end = start.clone();
                end.add('m', <%= @messages_thread.computed_data[:duration] %>);

                $(".calendar-container").addClass("minimized");

                var location = [];

                if(meetingRoomManager && meetingRoomManager.usingMeetingRoom && meetingRoomManager.selectedRoom && meetingRoomManager.selectedRoom.id != 'auto_room_selection') {
                    location.push(meetingRoomManager.selectedRoom.summary);
                }

                location.push(window.threadComputedData.location);

                location = location.join(', ');

                var emailInNotes = "";

                // include_email_in_notes here

                if(window.getCurrentAppointment().include_email_in_notes) {
                    <% server_message = @messages_thread.messages.select{|m| m.id == @julie_action.message_classification.message_id}.first.server_message %>
                    var textData = <%== {text: "#{"- "*30}\n#{server_message['subject']}\n#{server_message['text']}\n#{"- "*30}"}.to_json %>;

                    emailInNotes = "\n\n" + textData.text;
                }

                var requestParams = {};

                if(vmHelper && vmHelper.isVirtualAppointment() && vmHelper.selectedVirtualResource !== undefined) {
                    requestParams['virtual_resource_id'] = vmHelper.selectedVirtualResource.id;
                    // Allows us to refresh the notes with the currently selected virtual resource instructions
                    forceUpdateNotesCallingInfos();
                }

                //var description = window.threadComputedData.notes + "\n" + window.threadComputedData.other_notes + emailInNotes;
                // Allow us to pick up the changes made to the notes when on the julieAction Page (when the form is not editable for example)
                var description = $('#notes').val() + "\n" + $('#other_notes').val() + emailInNotes;

                if(window.getCurrentAppointment().appointment_kind_hash.is_virtual){
                    if(window.threadComputedData.call_instructions.event_instructions)
                        location = window.threadComputedData.call_instructions.event_instructions;

                    if(window.currentEventTile) {
                        var currentEventNotesNode = $('.created-event-panel .notes');
                        var currentEventNotes = currentEventNotesNode.val();
                        var newEventDescription = '';
                        if(vmHelper && vmHelper.isVirtualAppointment()){
                            var otherNotesRegex = new RegExp(/- - - - - - - - - - - - - - - - - - - - - - - - - - - - - -(.)* /g);
                            var regExResult = otherNotesRegex.exec(currentEventNotes.replace(/\n/g,'__n'));
                            if(regExResult != null){
                                newEventDescription = $('.classic-info-panel #notes').val() + "\n\n" + regExResult[0].replace(/__n/g,'\n');
                                description = newEventDescription;
                            }
                        }
                    }
                }

                requestParams = $.extend(requestParams, {
                    action: "create_event",
                    email: "<%= @messages_thread.account_email %>",
                    summary: window.threadComputedData.summary,
                    description: description,
                    attendees: <%== @messages_thread.computed_data[:attendees].select{|a| a['isPresent'] == 'true' && a['email'].present?}.to_json %>,
                    location: location,
                    all_day: false,
                    private: window.threadComputedData.private,
                    start: start.format(),
                    end: end.format(),
                    start_timezone: currentTimezone,
                    end_timezone: currentTimezone,
                    calendar_login_username: window.threadComputedData.calendar_login_username,
                    meeting_room: {used: meetingRoomManager.usingMeetingRoom, selected: meetingRoomManager.selectedRoom}
                });

                if(isPostpone && !window.currentEventFromInvitation) {
                    window.currentEventId = "<%= @messages_thread.event_data[:event_id] %>";
                    window.currentEventUrl = "<%= @messages_thread.event_data[:event_url] %>";
                    window.currentCalendarId = "<%= @messages_thread.event_data[:calendar_id] %>";
                    // For backslahes to work in JS
                    window.currentCalendarLoginUsername = "<%= "#{@messages_thread.event_data[:calendar_login_username]}".gsub(/\\/, "\\\\\\\\") %>";
                    _.each({
                        action: "update_event",
                        event_id: window.currentEventId,
                        event_url: window.currentEventUrl,
                        calendar_id: window.currentCalendarId,
                        calendar_login_username: window.currentCalendarLoginUsername
                    }, function(v, k) {
                        requestParams[k] = v;
                    });
                }

                if(window.currentEventFromInvitation) {
                    window.currentEventTile.doneEditingCallback = function() {
                        window.actionDeletedEvent = true;
                        createOrUpdateEvent(start, requestParams);
                    };
                    window.currentEventTile.deleteEvent();
                }else {
                    createOrUpdateEvent(start, requestParams);
                }
            }
            else {
                var availableTimeSlots = [eventCreatorManager.selectedDateRaw];
                var messageBuilder = $('#reply-area').scope();
                $(".calendar-container").addClass("minimized");
                window.setReplyMessage(messageBuilder.generateReply({
                    action: "client_agreement",
                    isPostpone: isPostpone,
                    dateTimesToCheck: availableTimeSlots,
                    isAvailable: true,
                    appointment: window.getCurrentAppointment(),
                    timezoneId: window.threadComputedData.timezone,
                    defaultTimezoneId: window.threadAccount.default_timezone_id,
                    locale: window.threadComputedData.locale
                }), "only_client");
            }
            $('.email.extended').removeClass('extended');
        });
    });

    var createOrUpdateEvent = function(start, requestParams) {
        CommonHelpers.externalRequest(requestParams, function (e) {
            var currentAppointment = window.getCurrentAppointment();
            var eventCreatorManager = $('#datesVerificationsManager').scope();
            var meetingRoomsManager = $('#meeting-rooms-manager').scope();
            var vmHelper = angular.element($('#virtual-meetings-helper')).scope();

            var virtualResourcesUsed = false;

            window.currentCalendar.refreshEvents();

            if(!isPostpone || window.currentEventFromInvitation) {
                window.currentEventId = e.data.event_id;
                window.currentEventUrl = e.data.event_url;
                window.currentCalendarId = e.data.calendar_id;
                window.currentCalendarLoginUsername = window.threadComputedData.calendar_login_username;
            }

            var message = '';
            var callInstructionsMessage = '';

            var messageBuilder = $('#reply-area').scope();
            var attendeesMng = $('#attendeesCtrl').scope();

            var attendeesWithMissingInfos = window.getPresentAttendeesWithMissingInfos();

            var messageParams1 = {
                action: "invites_sent",
                isPostpone: isPostpone && !window.currentEventFromInvitation,
                timeSlotToCreate: eventCreatorManager.selectedDateRaw,
                usedTimezones: eventCreatorManager.getUsedTimezones(),
                appointment: currentAppointment,
                address: window.getCurrentAddress(),
                timezoneId: window.threadComputedData.timezone,
                defaultTimezoneId: window.threadAccount.default_timezone_id,
                allTimezoneIds: <%== @messages_thread.all_timezones.to_json %>,
                attendeesWithMissingInfos: attendeesWithMissingInfos,
                locale: window.threadComputedData.locale,
                usingRestaurantBooking: window.threadComputedData.using_restaurant_booking
            };

            if(currentAppointment && currentAppointment.appointment_kind_hash.is_virtual) {


                if(meetingRoomsManager && meetingRoomsManager.usingMeetingRoom && meetingRoomsManager.selectedRoom && meetingRoomsManager.selectedRoom.id != 'auto_room_selection') {
                    messageParams1.usingMeetingRoom = meetingRoomsManager.usingMeetingRoom;
                    messageParams1.threadOwnerCompanyName = meetingRoomsManager.attendeesManagerCtrl.getThreadOwner().company;
                    messageParams1.selectedRoomName = meetingRoomsManager.selectedRoom.summary;
                }
            }

            message += messageBuilder.generateReply(messageParams1);

            var data = {
                event_id: window.currentEventId,
                event_url: window.currentEventUrl,
                calendar_id: window.currentCalendarId,
                calendar_login_username: window.currentCalendarLoginUsername,
                done: true,
                messages_thread_id: "<%= @messages_thread.id %>",
                event_booked_date: start.format(),
                client_settings: window.getClientSettings()
            };

            if(meetingRoomsManager && meetingRoomsManager.usingMeetingRoom && meetingRoomsManager.selectedRoom && meetingRoomsManager.selectedRoom.id != 'auto_room_selection') {
                data.using_meeting_room = true;
                data.meeting_room_details = {selected_meeting_room: meetingRoomsManager.selectedRoom};
            }

            data.virtual_resource_used = 'undefined';
            if(vmHelper && vmHelper.isVirtualAppointment()) {
                if(vmHelper.selectedVirtualResource !== undefined) {
                  data.notes_updated = $('#notes').val();

                  data.virtual_resource_used = vmHelper.selectedVirtualResource;
                  virtualResourcesUsed = true;
                }
            }

            if(window.threadComputedData.is_virtual_appointment){
                var call_instructions = window.threadComputedData.call_instructions;

                if(isPostpone){
                    if($('#event_update_vm_ctrl').length > 0)
                        call_instructions = angular.element($('#event_update_vm_ctrl')).scope().currentConf;
                    else
                        call_instructions = window.threadComputedData.call_instructions;

                    data['call_instructions'] = call_instructions;

                    angular.element($('#attendeesCtrl')).scope().confirmAIOnPresentAttendees();
                    // We resynchronize the contacts when updating the event in case we updated the call instructions of one of them
                    $.ajax({
                        url: "/client_contacts/synchronize",
                        type: "POST",
                        data: {client_email: window.threadAccount.email, contacts: JSON.stringify(window.getInfoPanelAttendees())},
                        success: function (e) {
                            console.log('Contacts Synchronized');
                        },
                        error: function (e) {
                            console.log("Error: ", e);
                        }
                    });
                }
                var messageParams = {
                    action: 'send_call_instructions',
                    callInstructions: call_instructions,
                    locale: window.threadComputedData.locale,
                    virtualResourcesUsed: virtualResourcesUsed
                };
                var currentAppointmentKind = currentAppointment.appointment_kind_hash.family_kind;

                if(( currentAppointmentKind == 'call' || currentAppointmentKind == 'skype' ) && !call_instructions.details){
                    messageParams['askCallInstructions'] = attendeesMng.mustAskCallInstructions(currentAppointmentKind);
                }

                callInstructionsMessage = messageBuilder.generateReply(messageParams);

                if(callInstructionsMessage != ''){
                    message += "\n\n";

                    message += callInstructionsMessage;
                }
            }

            if(messageParams && messageParams['askCallInstructions'] && attendeesWithMissingInfos == 1) {
                // We don't generate the "Xx, please also provide your hpone number, just in case!" when we are in a virtual appointment
                // where we ask for the call instructions and there are only one attendee with missing infos
                // It would create a duplicate question
            } else {
                var courtesyStringNeeded = !currentAppointment.appointment_kind_hash.is_virtual && !window.getCurrentAddress();
                var previousInformationGivenOrAsked = (callInstructionsMessage != '' || courtesyStringNeeded);
                var missingInfosMessage = attendeesMng.checkMissingInformations({redundantCourtesy: previousInformationGivenOrAsked, sticky: previousInformationGivenOrAsked});
                if(missingInfosMessage != ''){
                    message += missingInfosMessage;
                }
            }

            window.setReplyMessage(message, 'all', window.otherEmails);

            $(".messages-thread-info-panel .create-event-panel").hide();

            $(".messages-thread-info-panel .message-container").hide();
            $(".julie-action-title .title").html("<%= I18n.t("common.to_do") %> <%= I18n.t("actions.send_confirmation_email.todo")%>");

            window.currentEventTile = new EventTile($(".messages-thread-info-panel .created-event-panel"), {
                timezoneId: window.threadComputedData.timezone,
                mode: "read_only",
                event: {},
                eventId: window.currentEventId,
                eventUrl: window.currentEventUrl,
                calendarId: window.currentCalendarId,
                calendarLoginUsername: window.currentCalendarLoginUsername,
                accountEmail: window.threadAccount.email,
                locale: window.threadComputedData.locale
            });

            $(".messages-thread-info-panel .created-event-panel").show();
            window.currentEventTile.redraw();
            window.currentEventTile.fetchEvent(function(data) {
                window.currentEventTile.displayCallingInfosForm();
                window.currentEventData = data;
                window.currentEventTile.redraw();
                setTimeout(function () {
                    $(".left-column").animate({scrollTop: $(".reply-box").position().top + 30}, 300);
                }, 1000);
            });

            $.ajax({
                type: "post",
                url: "/julie_actions/<%= @julie_action.id %>/update",
                data: data,
                success: function (e) {
                    $(".creating-event-message").html("Created.");
                }
            });
        }, function () {
            $(".creating-event-message").html("Problem while creating.");
            window.currentCalendar.refreshEvents();
            $("#create-event-button").removeAttr('disabled');
            $("#invitation-already-sent-button").removeAttr('disabled');
        });
    };

    var checkAvailabilitiesClassicReply = function() {
        var event_start_date = '';

        if(window.currentEventData && window.currentEventData.start)
            event_start_date = window.currentEventData.start.dateTime;

        $.ajax({
            url: "/julie_actions/<%= @julie_action.id %>/update",
            method: "post",
            data: {
                text: $("textarea#reply-text").val(),
                generated_text: window.currentFullMessageWithFooter,
                timezone: $('#dates_suggestion_timezone').val(),
                to: window.currentRecipients().to,
                cc: window.currentRecipients().cc,
                date_times: window.timeSlotsToSuggest,
                event_id: window.currentEventId,
                event_url: window.currentEventUrl,
                calendar_id: window.currentCalendarId,
                calendar_login_username: window.currentCalendarLoginUsername,
                deleted_event: window.actionDeletedEvent,
                done: true,
                processed_in: Date.now() - window.startedAt,
                messages_thread_id: "<%= @messages_thread.id %>",
                event_booked_date: event_start_date,
                client_settings: window.getClientSettings()
            }
        });
        window.sendReply();
    };


    window.clickReplyButton = function () {
        if(isPostpone && window.timeSlotsToSuggest && window.timeSlotsToSuggest.length > 0) {
            window.deleteEventBeforeReply(function() {
                checkAvailabilitiesClassicReply();
            });
        }
        else {
          if(window.timeSlotsToSuggest && window.timeSlotsToSuggest.length > 0) {
            var datesSuggestionManager = $('#dates-suggestion-manager').scope();
            datesSuggestionManager.trackSuggestedDates();
          }
          checkAvailabilitiesClassicReply();
        }
    };


    window.addEventListener("message", function (event) {

        if(event.data.message == "drawExternalEventSelection") {
            var events = event.data.events;
            var currentSelectedEvent = _.last(events);

            _.each(currentCalendar.selectedEvents, function(e) {
                if(e.id != currentSelectedEvent.id)
                    currentCalendar.selectEvent(e);
            });

            window.selectedEvents = currentCalendar.selectedEvents[0] ? [currentCalendar.selectedEvents[0]] : [];

            window.redrawSelectedEventsContainer();

            if(currentSelectedEvent) {
                setInvitationConfirmedReplyText();
            }
        }else if (event.data.message == "drawExternalEventsList") {
            window.timeSlotsToSuggest = event.data.date_times;

            if(window.invitationAlreadySent){
                window.redrawTimeSlotsToSuggestContainer();
                setInvitationDeclinedNewAvailabilitesReplyText();

                $(".time-slots-to-suggest-list-container .suggest-dates-next-button").off('click');

                $(".time-slots-to-suggest-list-container .suggest-dates-next-button").click(function(e) {
                    $(".calendar-container").addClass("minimized");
                    $('.email.extended').removeClass('extended');
                    $(".left-column").animate({scrollTop: $(".reply-box").position().top + 30}, 300);
                })
            }else{
                var messageBuilder = $('#reply-area').scope();
                var datesSuggestionsManager = $('#dates-suggestion-manager').scope();
                var threadComputedData = window.threadComputedData;

                window.redrawTimeSlotsToSuggestContainer();

                window.setReplyMessage(messageBuilder.generateReply({
                    action: "suggest_dates",
                    client_agreement: true,
                    attendeesAreNoticed: true,
                    isPostpone: isPostpone,
                    locale: threadComputedData.locale,
                    appointment: window.getCurrentAppointment(),
                    address: window.getCurrentAddress(),
                    timeSlotsToSuggest: datesSuggestionsManager.getTimeSlotsSuggestionsForTemplate(),
                    usedTimezones: datesSuggestionsManager.getUsedTimezones(),
                    threadMainTimezone: threadComputedData.timezone,
                    client: window.threadAccount.usage_name,
                    timezoneId: threadComputedData.timezone,
                    noDateFits: noDateFitsType,
                    defaultTimezoneId: window.threadAccount.default_timezone_id
                }), "all", window.otherEmails);
            }
        }
        else if (event.data.message == "drawExternalEventCreation") {
            var eventCreatorApp = $('#datesVerificationsManager').scope();

            eventCreatorApp.addNewDateToVerify({
                date: moment(event.data.eventStart).utc().format(),
                timezone: window.currentCalendar.getCalendarTimezone()
            });
            eventCreatorApp.$apply();
            window.timeSlotToCreate = event.data.eventStart;
//            $(".suggested-date-times .suggested-date-time").removeClass("btn-primary");
//            $(".suggested-date-times .suggested-date-time.other").remove();
//            $(".suggested-date-times .suggested-date-time").each(function () {
//                if (moment($(this).data("date")).isSame(moment(event.data.eventStart))) {
//                    $(this).addClass("btn-primary");
//                    window.timeSlotToCreateTimezone = $(this).data("timezone");
//                }
//            });
//            if ($(".suggested-date-times .suggested-date-time.btn-primary").length == 0) {
//                var dateString = moment(event.data.eventStart).tz(window.currentCalendar.getCalendarTimezone()).locale("<%= I18n.locale %>").format("dddd DD MMMM YYYY Ã  HH:mm");
//                window.timeSlotToCreateTimezone = window.currentCalendar.getCalendarTimezone();
//                $(".suggested-date-times").append(
//                        $("<div>")
//                                .addClass("suggested-date-time other btn btn-sm btn-block btn-primary")
//                                .html(dateString + "<br>" + window.currentCalendar.getCalendarTimezone())
//                );
//            }
//            $("#create-event-button").removeAttr('disabled');
//            $("#invitation-already-sent-button").removeAttr('disabled');
        }
    }, false);
</script>