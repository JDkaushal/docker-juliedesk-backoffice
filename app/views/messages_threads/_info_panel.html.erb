<script>
    setCurrentLocale("<%= I18n.locale %>");

    window.threadAccount = <%== @messages_thread.account.to_json %>;

    window.threadComputedData = <%== @messages_thread.computed_data.to_json %>;
    window.threadAccount = <%== @messages_thread.account.to_json %>;

    window.otherAccountEmails = _.map(window.threadComputedData.attendees, function (attendee) {
        return attendee.account_email;
    });
    window.otherAccountEmails = _.filter(window.otherAccountEmails, function (email) {
        return email && email != "<%= @messages_thread.account_email %>";
    });

    window.virtualAppointmentNatures = <%== MessagesThread.virtual_appointment_natures.to_json %>;

    $(function () {
        if (window.leftColumnMessage) {
            $(".messages-thread-info-panel .message-container").html(window.leftColumnMessage).show();
        }
        initAppointments();

        $(".validate-linear-form-entry-button").click(function() {
            askNextLinearFormEntry();
        });

        var possibleAttendees = window.getInfoPanelAttendees();
        possibleAttendees.push({
            email: window.threadAccount.email,
            name: window.threadAccount.full_name
        });

        _.each(window.threadComputedData.constraints_data, function(constraintData) {
            $(".messages-thread-info-panel .constraint-tiles-container").append($("<div>").addClass("constraint-tile-container"));
            new ConstraintTile($(".messages-thread-info-panel .constraint-tiles-container").find(".constraint-tile-container").last(), {
                possibleAttendees: possibleAttendees,
                data: constraintData,
                locale: "<%= I18n.locale %>",
                timezone: window.threadAccount.default_timezone_id
            });
        });

        $(".add-constraint-button").click(function() {
            $(".messages-thread-info-panel .constraint-tiles-container").append($("<div>").addClass("constraint-tile-container"));
            new ConstraintTile($(".messages-thread-info-panel .constraint-tiles-container").find(".constraint-tile-container").last(), {
                possibleAttendees: possibleAttendees,
                locale: "<%= I18n.locale %>",
                timezone: window.threadAccount.default_timezone_id
            });
        });

        redrawLinearForm();
        if (window.threadDataIsEditable) {
            $("#timezone").timezonePicker();
            <% if messages_thread.account.calendar_nature != "google" %>
            $(".data input#private").prop('disabled', true);
            <% end %>
            $(".data textarea#notes").prop('disabled', true);
            $(".send-to-founders-container").show();
            $(".add-constraint-button").show();
        }
        else {
            $(".data input, .data textarea, .data select").prop('disabled', true);
            $(".data-entry .add-attendee-container").hide();
            $(".linear-form-entry .validate-linear-form-entry-button").hide();
            $(".send-to-founders-container").hide();
            $(".add-constraint-button").hide();
        }
        if (window.afterFormLoadedCallback) {
            window.afterFormLoadedCallback();
        }

        $("#appointment_nature").change(function () {
            setAppointmentValues();
            if($(".linear-form-entry[data-entry-name='timezone']:hidden").length > 0 && $("#appointment_nature").val()) {
                    askNextLinearFormEntry();
            }
        });

        $("input[name='locale']").change(function () {
            setNotes();
            reProcessTitle();
        });

        $("body").on("change", "input#attendee", function() {
            reProcessTitle();
        });
        $("body").on("change", "input#attendee_name", function() {
            reProcessTitle();
        });

        $("body").on("change", "select#location_nature", function () {
            setAddressValues();
        });


        $("#current_notes").height($("#current_notes")[0].scrollHeight);



        $(".submit-classification").click(function () {
            $(this).attr('disabled', true);
            if (window.submitClassification) {
                window.submitClassification();
            }
        });

        $(".data #add-attendee-button").click(function (e) {
            var email = $(".data #add_attendee").val();
            $(".data #add_attendee").val("");
            var $contact = $("<div>").addClass("contact").data("email", email).data("name", "");
            $contact.append($("<input type='checkbox' checked>").val(email).attr('id', "attendee"));
            var $nameAndEmail = $("<div>").addClass("attendee-name-and-email");
            $nameAndEmail.append($("<input type='text'>").attr("id", "attendee_name").val("").attr("placeholder", "<%= I18n.t("info_box.full_name_placeholder") %>"));
            $nameAndEmail.append($("<div>").addClass("attendee-email").html(email));
            $contact.append($nameAndEmail);
            $(".data #contacts-data-list").append($contact);
            reProcessTitle();
        });

        <% if messages_thread.event_data[:event_id] %>


        var $eventDoesNotExist = $("<div>").addClass("event-does-not-exist");
        $eventDoesNotExist.append($("<div>").html(localize("info_panel.event_does_not_exist_anymore")));
        $eventDoesNotExist.append($("<a href='/messages_threads/<%= messages_thread.id %>/remove_event_link'>").addClass("btn btn-success btn-block").html(localize("info_panel.remove_link")));
        window.currentEventTile = new EventTile($(".messages-thread-info-panel .created-event-panel"), {
            timezoneId: window.threadComputedData.timezone,
            mode: "read_only",
            event: {},
            eventId: "<%= messages_thread.event_data[:event_id] %>",
            calendarId: "<%= messages_thread.event_data[:calendar_id] %>",
            accountEmail: window.threadAccount.email,
            locale: window.threadComputedData.locale,
            eventDoesNotExistSelector: $eventDoesNotExist,
            doneEditingCallback: function() {

            }
        });
        $(".messages-thread-info-panel .created-event-panel").show();
        window.currentEventTile.redraw();
        window.currentEventTile.fetchEvent(function(data) {
            window.currentEventData = data;
            window.currentEventTile.redraw();
            if(window.afterEventFetched) {
                window.afterEventFetched();
            }
        });

        <% end %>

        fetchOtherAccounts();
    });

    window.getCurrentAppointment = function() {
        return $.grep(window.threadAccount.appointments,function(v) {
            return v.label == $("select#appointment_nature").val();
        })[0];
    };
    window.getCurrentAddress = function() {
        var currentAppointment = window.getCurrentAppointment();
        if(!currentAppointment) {
            return null;
        }
        var address = _.find(currentAppointment.addresses_with_description, function(addressObject) {
            return addressObject.label == $("select#location_nature").val();
        });
        if(address) {
            return address;
        }
        else if($("#location").val().length > 0) {
            return $("#location").val();
        }
        return null;
    };


    function reProcessTitle() {
        var appointment = $.grep(window.threadAccount.appointments, function (v) {
            return v.label == $("#appointment_nature").val();
        })[0];
        var contactNames = $("input#attendee[type='checkbox']:checked").map(function() {
            return $(this).closest(".contact").find("input#attendee_name").val();
        }).get();
        contactNames.push(window.threadAccount.full_name);
        $("input#summary").val(appointment.title_in_calendar[$("input[name='locale']:checked").val()] + " " + contactNames.join(" / "));
    }

    function fetchOtherAccounts() {
        $(".other-accounts").hide();
        $(".other-accounts-list").html("");
        for (var i in window.otherAccountEmails) {
            var otherAccountEmail = window.otherAccountEmails[i];
            CommonHelpers.externalRequest({
                action: "show_account",
                email: otherAccountEmail
            }, function (sae) {
                $(".other-accounts").show();
                var $otherAccount = $("<div>").addClass("other-account");
                $otherAccount.append($("<div>").addClass("other-account-name").html(sae.data.full_name));
                $otherAccount.append($("<div>").addClass("other-account-email").html(sae.data.email));
                $otherAccount.append($("<div>").addClass("other-account-preferences").html(sae.data.raw_preferences));
                $otherAccount.append($("<div>").addClass("other-account-current-notes").html(sae.data.current_notes));
                $(".other-accounts-list").append($otherAccount);
            }, function (sae) {

            });
        }
    }

    function initAppointments() {
        $("select#appointment_nature").html("");
        _.each(window.threadAccount.appointments, function(appointment) {
            $("select#appointment_nature").append($("<option>").val(appointment.label).html(appointment.label));
        });

        $("select#appointment_nature").val(window.threadComputedData.appointment_nature);
        if (window.threadComputedData.appointment_nature) {
            initAddresses();
            if (window.threadComputedData.location_nature) {
                $("select#location_nature").val(window.threadComputedData.location_nature);
            }
        }

    }

    function redrawLinearForm() {
        if(!window.threadComputedData.appointment_nature) {
            $(".linear-form-entry").hide();
        }
        else {
            $(".linear-form-entry .validate-linear-form-entry-button").hide();
        }
        if(window.threadDataIsEditable) {
            if(window.threadComputedData.appointment_nature) {
                $(".save-info-container").show();
            }
            else {
                $(".linear-form-entry:hidden:eq(0)").show();
            }
        }

    }

    function askNextLinearFormEntry() {
        $(".linear-form-entry:visible .validate-linear-form-entry-button").hide();
        if($(".linear-form-entry:hidden").length ==0) {
            $(".save-info-container").show();
        }
        else {
            $(".linear-form-entry:hidden:eq(0)").show();
        }
        $(".messages-thread-info-panel").scrollTop($(".messages-thread-info-panel")[0].scrollHeight);
    }

    function initAddresses() {
        var appointment = $.grep(window.threadAccount.appointments, function (v) {
            return v.label == $("#appointment_nature").val();
        })[0];

        $("select#location_nature").html("");
        _.each(window.threadAccount.addresses, function(addressObject) {
            $("select#location_nature").append($("<option>").val(addressObject.label).html(addressObject.label));
        });
        $("select#location_nature").append($("<option>").val("Custom").html("Custom"));
        $("select#location_nature").val("Custom");
        if (appointment.default_address) {
            $("select#location_nature").val(appointment.default_address.label);
        }
    }

    function setAppointmentValues() {
        var appointment = $.grep(window.threadAccount.appointments, function (v) {
            return v.label == $("#appointment_nature").val();
        })[0];

        var $timezoneEntryName = $(".linear-form-entry[data-entry-name='timezone']").find(".data-entry-name");
        if(window.virtualAppointmentNatures.indexOf(appointment.label) > -1) {
            $timezoneEntryName.html("<%= I18n.t("info_box.timezone_for_virtual") %>");
        }
        else {
            $timezoneEntryName.html("<%= I18n.t("info_box.timezone_for_physical") %>");
        }

        $("input#duration").val(appointment.duration);
        reProcessTitle();
        initAddresses();


        setAddressValues();
    }

    function setAddressValues() {
        var appointment = _.find(window.threadAccount.appointments, function (appointmentObject) {
            return appointmentObject.label == $("#appointment_nature").val();
        });

        var address = _.find(window.threadAccount.addresses, function (addressObject) {
            return addressObject.label == $("select#location_nature").val();
        });

        if (address) {
            $("input#location").val(address.address).attr('disabled', true);
        }
        else {
            $("input#location").val("").removeAttr('disabled');
        }

        setNotes();
    }

    function setNotes() {
        var appointment = _.find(window.threadAccount.appointments, function (appointmentObject) {
            return appointmentObject.label == $("#appointment_nature").val();
        });

        var address = _.find(window.threadAccount.addresses, function (addressObject) {
            return addressObject.label == $("select#location_nature").val();
        });

        var notes = appointment.note[$("input[name='locale']:checked").val()];
        if (address) {
            var addressComplement = address.address_complement;
            if(addressComplement && addressComplement.length > 0) {
                notes = addressComplement + "\n" + notes;
            }
            $("textarea#notes").val(notes);
        }
        else {
            $("textarea#notes").val(notes);
        }
    }

    window.getInfoPanelAttendees = function() {
        return $("input#attendee[type='checkbox']:checked").map(function() {
            var $contact = $(this).closest(".contact");

            return {
                name: $contact.find("input#attendee_name").val(),
                email: $contact.find(".attendee-email").html()
            };
        }).get();
    };
</script>

<div class="messages-thread-info-panel">

  <div class="message-container"></div>

  <div id="thread-header-other-entries-container"></div>

  <%= render partial: "messages_threads/client_agreement_panel", locals: {messages_thread: messages_thread, classification: local_assigns[:classification]} %>

  <%= render partial: "messages_threads/attendees_are_noticed_panel", locals: {messages_thread: messages_thread, classification: local_assigns[:classification]} %>

  <div class="created-event-panel"></div>

  <%= render partial: "messages_threads/create_event_panel", locals: {messages_thread: messages_thread, julie_action: local_assigns[:julie_action]} %>


  <div class="only-locale-panel">
    <div class="data-entry">
      <div class="data-entry-name"><%= I18n.t("info_box.locale") %></div>
      <div class="semi-data-entry">
        <%= radio_button_tag :locale_only, "fr", (messages_thread.computed_data[:locale] != "en") %> <%= I18n.t("info_box.french") %>
      </div>
      <div class="semi-data-entry">
        <%= radio_button_tag :locale_only, "en", (messages_thread.computed_data[:locale] == "en") %> <%= I18n.t("info_box.english") %>
      </div>
      <br>
      <br>
      <button class="btn btn-block btn-success validate-locale-button"><%= I18n.t("common.validate") %></button>
    </div>
  </div>

  <div class="classic-info-panel">


    <div class="account">
      <% account = messages_thread.account %>
      <% if account %>
          <%= account.usage_name %> (<%= messages_thread.account.email %>)
          <div class="account-details">
            <%= simple_format account.raw_preferences %>
            <%= text_area_tag :current_notes, account.current_notes, class: "current-notes form-control", disabled: true %>
          </div>
          <div class="other-accounts">
            <div class="other-accounts-title">Other accounts</div>
            <div class="other-accounts-list"></div>
          </div>
      <% else %>
          <%= I18n.t("info_box.no_account_found") %>
      <% end %>
    </div>


    <div class="data">
      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.locale") %></div>
        <div class="semi-data-entry">
          <%= radio_button_tag :locale, "fr", (messages_thread.computed_data[:locale] != "en") %> <%= I18n.t("info_box.french") %>
        </div>
        <div class="semi-data-entry">
          <%= radio_button_tag :locale, "en", (messages_thread.computed_data[:locale] == "en") %> <%= I18n.t("info_box.english") %>
        </div>

        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>



      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.appointment_type") %></div>
        <%= select_tag :appointment_nature, "", class: "data-entry form-control" %>
      </div>

      <div class="data-entry linear-form-entry" data-entry-name="timezone">
        <div class="data-entry-name"><%= I18n.t("info_box.timezone") %></div>
        <%= text_field_tag :timezone, messages_thread.computed_data[:timezone], class: "data-entry form-control" %>
        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>

      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.attendees") %></div>
        <div class="data-entry-value" id="contacts-data-list">
          <% attendees = messages_thread.computed_data[:attendees] || [] %>
          <% possible_attendees = messages_thread.contacts() + attendees.map(&:symbolize_keys) %>
          <% same_company_attendees = messages_thread.account.contacts_from_same_company %>
          <% (possible_attendees + same_company_attendees).uniq { |co| co[:email] }.each do |contact| %>
              <% attendee = attendees.select { |att| att['email'] == contact[:email] }.first %>
              <% checked = attendee || (
                messages_thread.computed_data[:appointment_nature].nil? &&
                possible_attendees.include?(contact)
              ) %>
              <div class="contact" data-email="<%= contact[:email] %>" data-name="<%= contact[:name] %>">
                <%= check_box_tag :attendee, contact[:email], checked %>
                <div class="attendee-name-and-email">
                  <%= text_field_tag :attendee_name, attendee.try(:[], 'name') || contact[:name], placeholder: I18n.t("info_box.full_name_placeholder") %>
                  <div class="attendee-email"><%= contact[:email] %></div>
                </div>

              </div>
          <% end %>
        </div>
        <div class="add-attendee-container">
          <%= text_field_tag :add_attendee, "", class: "", placeholder: I18n.t("info_box.email_placeholder") %>
          <div id="add-attendee-button" class="btn btn-xs btn-primary"><%= I18n.t("common.add") %></div>
        </div>
        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>



      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.ticket_notes") %></div>
        <%= text_area_tag :constraints, messages_thread.computed_data[:constraints], class: "data-entry form-control" %>

        <div class="constraint-tiles-container">

        </div>
        <div class="add-constraint-button btn btn-primary btn-sm btn-block">Add constraint</div>

        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>



      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.summary") %></div>
        <%= text_field_tag :summary, messages_thread.computed_data[:summary], class: "data-entry form-control" %>
        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>

      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.duration") %></div>
        <%= text_field_tag :duration, messages_thread.computed_data[:duration], class: "data-entry form-control" %>
        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>

      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.location") %></div>
        <%= select_tag :location_nature, "", class: "data-entry form-control" %>
        <%= text_field_tag :location, messages_thread.computed_data[:location], class: "data-entry form-control" %>
        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>



      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.private_event") %></div>
        <div class="data-entry-value">
          <%= check_box_tag :private, "", messages_thread.computed_data[:private] %>
          <%= I18n.t("info_box.private_event") %>
        </div>
        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>

      <div class="data-entry linear-form-entry">
        <div class="data-entry-name"><%= I18n.t("info_box.notes") %></div>
        <%= text_area_tag :notes, messages_thread.computed_data[:notes], class: "data-entry form-control" %>
        <%= text_area_tag :other_notes, messages_thread.computed_data[:other_notes], class: "data-entry form-control" %>
        <div class="validate-linear-form-entry-button btn btn-success btn-sm"><%= I18n.t("common.validate") %></div>
      </div>

      <div class="save-info-container">
        <br>
        <br>
        <button class="btn btn-block btn-success submit-classification"><%= I18n.t("common.save") %></button>
      </div>

      <% if local_assigns[:message] %>
          <div class="send-to-founders-container">
            <%= I18n.t("info_box.an_hesitation") %>
            <br>
            <%= link_to I18n.t("info_box.send_to_founders"), {controller: :messages, action: :classifying, id: local_assigns[:message].id, classification: MessageClassification::TO_FOUNDERS}, class: "action", disabled: MessageClassification.is_disabled(message, MessageClassification::TO_FOUNDERS) %>
          </div>
      <% end %>
    </div>
  </div>

  <%= render partial: "messages_threads/dates_identification_panel", locals: {messages_thread: messages_thread} %>
</div>