
<script>
    window.timeSlotsToSuggest = [];
    window.timeSlotToCreate = null;
    window.currentEventId = null;
    <% if @action.action_nature == JulieAction::JD_ACTION_SUGGEST_DATES %>
        window.calendarParams = {
            mode: "suggest_dates",
            date_times: [],
            email: "<%= @message.messages_thread.account_email %>",
            duration: <%= @message.messages_thread.computed_data[:duration] || 60 %>
        };
    <% elsif @action.action_nature == JulieAction::JD_ACTION_CHECK_AVAILABILITIES %>
        window.calendarParams = {
            mode: "create_event",
            date_times: <%== @message.messages_thread.computed_data[:date_times].select{|dt| dt['date']}.map{|dt| dt['date']}.to_json %>,
            email: "<%= @message.messages_thread.account_email %>",
            duration: <%= @message.messages_thread.computed_data[:duration] || 60 %>
        };
    <% end %>


    $(function () {
        redrawReplyText();

        $("#create-event-button").click(function() {
            $("#create-event-button").attr('disabled', true);
            $(".creating-event-message").html("Creating...");
            var start = moment(window.timeSlotToCreate);
            var end = start.clone();
            end.add('m', <%= @message.messages_thread.computed_data[:duration] %>);
            CommonHelpers.externalRequest({
                action: "create_event",
                email: "<%= @message.messages_thread.account.email %>",
                summary: "<%= @message.messages_thread.computed_data[:summary] %>",
                description: "<%= @message.messages_thread.computed_data[:notes] %>",
                attendees: <%== @message.messages_thread.computed_data[:attendees].map{|contact| ApplicationHelper.hash_from_parenthesized_contact contact}.to_json %>,
                location: "<%= @message.messages_thread.computed_data[:location] %>",
                calendar_nature: "<%= @message.messages_thread.account.calendar_nature %>",
                start: start.format(),
                end: end.format()
            }, function(e) {
                window.currentEventId = e.data.event_id;
                $.ajax({
                    type: "post",
                    url: "/julie_actions/<%= @action.id %>/update",
                    data: {
                        event_ids: [window.currentEventId]
                    },
                    success: function(e) {
                        $(".creating-event-message").html("Created.");
                        window.currentCalendar.refreshEvents();
                        redrawReplyText();
                    }
                });
            }, function() {
                $(".creating-event-message").html("Problem while creating.");
                window.currentCalendar.refreshEvents();
                $("#create-event-button").removeAttr('disabled');
            });

        });

        $("#reply-button").click(function () {
            $(".reply-box #callback-message").html("Sending...");
            $("#reply-button").prop('disabled', true);

            <% if @action.action_nature == JulieAction::JD_ACTION_SUGGEST_DATES %>
                $.ajax({
                   url: "/julie_actions/<%= @action.id %>/update",
                   method: "post",
                   data: {
                       text: $("textarea#reply-text").val(),
                       date_times: window.timeSlotsToSuggest,
                       done: true
                   }
                });
            <% elsif @action.action_nature == JulieAction::JD_ACTION_CHECK_AVAILABILITIES %>
            $.ajax({
                url: "/julie_actions/<%= @action.id %>/update",
                method: "post",
                data: {
                    text: $("textarea#reply-text").val(),
                    event_ids: [window.currentEventId],
                    done: true
                }
            });
            <% end %>
            $.ajax({
                url: "/messages/<%= @message.id %>/reply",
                method: "post",
                data: {
                    text: $("textarea#reply-text").val()
                },
                success: function (e) {
                    $(".reply-box #callback-message").html("Sent.");
                    $("#reply-button").removeProp('disabled');
                },
                error: function (e) {
                    console.log("error", e);
                    $("#reply-button").removeProp('disabled');
                    $(".reply-box #callback-message").html("Error: " + e);
                }
            });
        });


        window.addEventListener("message", function (event) {
            if (event.data.message == "drawExternalEventsList") {
                window.timeSlotsToSuggest = event.data.date_times;
                redrawReplyText();
            }
            else if(event.data.message == "drawExternalEventCreation") {
                window.timeSlotToCreate = event.data.eventStart;
                $(".suggested-date-times .suggested-date-time").removeClass("btn-success");
                $(".suggested-date-times .suggested-date-time.other").remove();
                $(".suggested-date-times .suggested-date-time").each(function() {
                    if(moment($(this).data("date-time")).isSame(moment(event.data.eventStart))) {
                        $(this).addClass("btn-success");
                    }
                });
                if($(".suggested-date-times .suggested-date-time.btn-success").length == 0) {
                    $(".suggested-date-times").append($("<div>").addClass("suggested-date-time other btn btn-sm btn-block btn-success").html(moment(event.data.eventStart).format("dddd DD MMMM YYYY à HH:mm")));
                }
                $("#create-event-button").removeAttr('disabled');
            }
        }, false);

        function redrawReplyText() {
            var message = "";
            <% if @action.action_nature == JulieAction::JD_ACTION_SUGGEST_DATES %>
                if (window.timeSlotsToSuggest.length > 0) {
                    message = "<%= @message.messages_thread.account.usage_name %> est disponible pour un <%= @message.messages_thread.computed_data[:appointment_nature_nature] %> (<%= @message.messages_thread.computed_data[:location] %>) :";
                    for(var i in window.timeSlotsToSuggest) {
                        var timeSlot = timeSlotsToSuggest[i];
                        message += "\n  - " + capitalize(moment(timeSlot).locale("fr").format("dddd DD MMMM YYYY à HH:mm"));
                    }
                    message += "\n\nQuel horaire vous convient le mieux ?"
                }
            <% elsif @action.action_nature == JulieAction::JD_ACTION_CHECK_AVAILABILITIES %>
                if(window.timeSlotToCreate) {
                    message = "Invitations envoyées pour un <%= @message.messages_thread.computed_data[:appointment_nature_nature] %> (<%= @message.messages_thread.computed_data[:location] %>), le " + capitalize(moment(window.timeSlotToCreate).locale("fr").format("dddd DD MMMM YYYY à HH:mm")) + ".";
                }
            <% elsif @action.action_nature == JulieAction::JD_ACTION_SEND_INFO %>

            <% elsif @action.action_nature == JulieAction::JD_ACTION_SEND_CONFIRMATION %>
                message = "J'ai bien noté que : ";
            <% end %>
            $("textarea#reply-text").val("Bonjour,\n\n" + message + "\n\nCordialement,\n\nJulie\nIntelligence artificielle")
            $("textarea#reply-text").elastic();
        }

        var capitalize = function(txt) {
            return txt[0].toUpperCase() + txt.substr(1);
        };
    });
</script>
<div class="row">
  <div class="email-column col-md-9">


    <div class="classification-form">
      <h4>To do: <%= I18n.t("actions.#{@action.action_nature}.todo") %></h4>
      <br>
      <br>

      <h5>When done:</h5>
      <%= link_to "Go to next item to classify", :next_to_classify_messages, class: "btn btn-success" %>
    </div>


    <br>
    <br>

    <% if @action.action_nature == JulieAction::JD_ACTION_SUGGEST_DATES %>
        <%= render template: "calendar/calendar" %>
    <% elsif @action.action_nature == JulieAction::JD_ACTION_CHECK_AVAILABILITIES %>
        <%= render template: "calendar/calendar" %>
  <% else %>

    <% end %>



    <div class="reply-box">
      <div class="from">From: julie@juliedesk.com</div>
      <div class="from">To: <%= @message.messages_thread.contacts(with_client: true).map { |c| "#{c[:name]} <#{c[:email]}>" }.join(", ") %></div>
      <textarea id="reply-text"></textarea>
      <button class="btn btn-success" id="reply-button">Reply</button>
      <div id="callback-message"></div>
    </div>

    <%= render template: "messages/email" %>
  </div>
  <%= render template: "messages/messages_thread_header" %>
</div>